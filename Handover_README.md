# Handover Document: GeoLDM Lipid Fine-tuning - Phase 1 to Phase 2

This document outlines the work completed in Phase 1 and provides instructions for Person 2 to complete Phase 2 of the GeoLDM fine-tuning project for conditional lipid generation based on TransLNP score.

## Phase 1 Deliverables

The following components have been created and are ready for use:

1.  **`preprocess_lipids.py`**: 
    *   **Purpose**: Processes raw data (CSV with SMILES/Scores, `./data/structures.sdf` with unscored lipids) into a unified format.
    *   **Generates**: `processed_lipid_data.pkl` and `lipid_stats.pkl`.

2.  **`processed_lipid_data.pkl`**: 
    *   **Format**: A Python list of dictionaries. Each dictionary represents a molecule with the following keys:
        *   `'atomic_numbers'`: NumPy array (dtype=int) of atomic numbers.
        *   `'positions'`: NumPy array (dtype=float, shape=[N, 3]) of atom coordinates.
        *   `'transfection_score'`: Float score value (if from CSV) or `None` (if from SDF).
        *   `'has_score'`: Boolean flag (True if score exists).
        *   `'origin_smiles'` (optional): Canonical SMILES if generated from CSV.
        *   `'origin_filename'` (optional): Filename if read from SDF.

3.  **`lipid_stats.pkl`**:
    *   **Format**: A Python dictionary containing normalization statistics for the `transfection_score` calculated *only* from the scored molecules:
        *   `'mean'`: Float mean value.
        *   `'std'`: Float standard deviation.

4.  **`GeoLDM/lipid_dataset.py`**:
    *   **Purpose**: Defines PyTorch `Dataset` (`LipidDataset`) and `Transform` (`LipidTransform`) for loading and preparing batches from the `.pkl` files.
    *   **Includes**: `get_dataloaders()` function to easily create train/validation/test dataloaders.
    *   **Uses**: Atom list `[1, 5, 6, 7, 8, 9, 13, 14, 15, 16, 17, 33, 35, 53, 80, 83]` based on `geom_with_h`.
    *   **Output Batch Format**: Dictionaries containing tensors for:
        *   `'positions'`, `'one_hot'`, `'atom_mask'`, `'charges'` (zeros), `'TransLNP'` (normalized or 0.0), `'has_score'`, `'num_nodes'`, and `'edge_mask'` (generated by the imported `collate_fn`).

5.  **`GeoLDM/qm9/utils.py` (Modified)**:
    *   **Change**: The `prepare_context` function now accepts an optional boolean argument `force_unconditional`.
    *   **Functionality**: If `force_unconditional=True`, the function generates and returns a zero tensor representing the null context. If `False`, it performs standard normalization and processing.

6.  **`GeoLDM/finetune_lipids.py` (Complete Script)**:
    *   **Purpose**: Ready-to-run script for fine-tuning the pretrained GeoLDM model (specified via `--pretrained_path`, expected to be `drugs_latent2/`) on the processed lipid data.
    *   **Features**:
        *   Loads pretrained GEOM model (`--model_name`, default `generative_model_ema.npy`) and arguments (`args.pickle`).
        *   Uses `lipid_dataset.get_dataloaders` for data loading.
        *   Loads `lipid_stats.pkl` for normalization (`property_norms`).
        *   **CFG Training**: Implemented inside the main training loop. It checks `--cfg_prob` and calls the modified `prepare_context` with `force_unconditional` set accordingly.
        *   **Loss Calculation**: Uses `qm9_losses.compute_loss_and_nll` from the original codebase, passing the model, data (`x`, `h`), masks, and context.
        *   Includes argument parsing, optimizer setup (re-initialized for fine-tuning), EMA handling, validation loop (calculating NLL), and checkpoint saving based on best validation NLL.

## Phase 2 Instructions (for Person 2)

Your goal is to take the deliverables from Phase 1, execute the fine-tuning, develop sampling and evaluation scripts, and complete the project.

1.  **Setup**: 
    *   Ensure you have a Python environment with all dependencies from `GeoLDM/requirements.txt` installed (PyTorch, RDKit, NumPy, Pandas, WandB, tqdm, etc.).
    *   Verify the paths in the execution command below are correct for your system.
    *   Place `processed_lipid_data.pkl` and `lipid_stats.pkl` in a location accessible by the script (e.g., `./processed_data/`).

2.  **Review**: 
    *   Read `GeoLDM/finetune_lipids.py` to understand the workflow.
    *   Review the command-line arguments below and adjust hyperparameters (`lr`, `n_epochs`, `batch_size`, `cfg_prob`) as needed.

3.  **Run Fine-tuning**: 
    *   Execute `GeoLDM/finetune_lipids.py` from the project root directory:
        ```bash
        python GeoLDM/finetune_lipids.py ^
            --pretrained_path ./GeoLDM/drugs_latent2 ^
            --lipid_data_path ./processed_data/processed_lipid_data.pkl ^
            --lipid_stats_path ./processed_data/lipid_stats.pkl ^
            --output_dir ./outputs ^
            --exp_name geoldm_lipid_finetune_run1 ^
            --lr 2e-5 ^
            --n_epochs 150 ^
            --batch_size 32 ^
            --ema_decay 0.999 ^
            --cfg_prob 0.1 ^
            --conditioning TransLNP 
            # --no_wandb # Uncomment if not using WandB
            # --num_workers 4 # Adjust based on your system
        ```
        *(Note: Using `^` for line continuation in Windows Powershell/CMD. Use `\` for Linux/macOS bash)*
    *   Monitor the training. Best model checkpoint saved to `./outputs/geoldm_lipid_finetune_run1/checkpoints/generative_model_ema_best.npy`.

4.  **Implement Sampling Script (`GeoLDM/sample_lipids.py`)**: 
    *   Use `GeoLDM/eval_conditional_qm9.py` or `GeoLDM/eval_sample.py` as a template.
    *   Load your fine-tuned checkpoint (`generative_model_ema_best.npy` and `args_best.pickle` from the output checkpoints directory).
    *   Load `./processed_data/lipid_stats.pkl` for score normalization.
    *   Implement the CFG sampling loop (details in the previous response or `Handover_README.md` v1).
    *   Save generated molecules (e.g., `.xyz`, `.sdf`).

5.  **Generate Samples**: 
    *   Run `GeoLDM/sample_lipids.py` with various target scores and guidance scales (`w`).

6.  **Implement Evaluation Script (`evaluate_lipids.py`)**: 
    *   Load generated molecules.
    *   Calculate validity, uniqueness, novelty (compare vs. `./data/train.csv` SMILES and potentially SMILES generated from `./data/structures.sdf`).
    *   (Recommended) Implement QSAR for property correlation.

7.  **Analyze and Report**: 
    *   Summarize results and package the project. 