# GeoLDM Fine-tuning for Conditional Ionizable Lipid Generation

This document outlines the current state of the project, the implemented two-stage fine-tuning workflow, and instructions for running the different steps to generate novel ionizable lipids conditioned on transfection score.

## Project Overview

The goal of this project is to fine-tune a pre-trained GeoLDM model (originally trained on GEOM-Drugs) to generate novel 3D ionizable lipid structures. The generation process is conditioned on a target property, specifically the `transfection_score`.

A two-stage fine-tuning approach is employed:
1.  **Stage 1 (Adaptation):** Adapt the pre-trained model to the general chemical space of lipids using a large unlabeled dataset.
2.  **Stage 2 (Conditional Fine-tuning):** Further fine-tune the adapted model using a smaller labeled dataset to learn the relationship between structure and the `transfection_score`.

## Setup

1.  **Environment**: Ensure you have a suitable Python environment (e.g., conda). Python 3.10 is recommended (required for the provided `unicore` wheel).
2.  **Dependencies**: Install the required libraries. Run the following commands in the project root directory:

    Create environment (example):
    ```bash
    conda create --name lipid_gen python=3.10
    conda activate lipid_gen
    ```

    Install core libraries (PyTorch, CUDA, RDKit):
    ```bash
    conda install -c pytorch -c nvidia -c conda-forge python=3.10 pytorch=2.0.0 torchvision=0.15.0 torchaudio pytorch-cuda=11.8 rdkit=2023.09.5 numpy=1.26.0
    ```

    Install other dependencies:
    ```bash
    pip install -r requirements.txt
    ```

3.  **Install `unicore` for TransLNP**: The TransLNP model evaluation (Step 6) requires the `unicore` library. Install it using the provided wheel file (assuming it's placed in the `TransLNP` directory and matches your environment - **Linux, Python 3.10, CUDA 11.8, PyTorch >= 2.0**):
    ```bash
    # On your Linux VM/environment:
    pip install TransLNP/unicore-*.whl
    ```
    *(Use the exact filename of your wheel file)*

4.  **Check TransLNP Requirements**: The `TransLNP` directory might have its own specific requirements not covered by the main `requirements.txt`. Check `TransLNP/requirements.txt` if you encounter issues during Step 6.

## Data

### Input Data

The workflow expects the following input files placed in the `data/` directory:

*   `data/train.csv`: Contains SMILES strings (column `SMILES`) and corresponding target transfection scores (column `TARGET`) for the labeled training set.
*   `data/test.csv`: Contains SMILES strings and scores for the labeled test/validation set. 
*   `data/structures.sdf`: An SDF file containing 3D coordinates for a potentially large set of *unlabeled* lipid molecules (scores are not required/used from this file). Used for Stage 1 adaptation.

### Processed Data (Generated by Scripts)

The preprocessing scripts will generate the following intermediate files in the `data/` directory:

*   `data/processed_train_lipids.pkl`: Python list of dictionaries for the labeled training set. Each dictionary contains:
    *   `'positions'`: NumPy array (float32, shape=[N, 3])
    *   `'one_hot'`: NumPy array (float32, shape=[N, AtomTypes]) - Based on `ATOM_DECODER = ['H', 'C', 'N', 'O', 'P']`.
    *   `'charges'`: NumPy array (float32, shape=[N, 1]) - Gasteiger charges.
    *   `'atom_mask'`: NumPy array (float32, shape=[N, 1]) - Mask of ones.
    *   `'transfection_score'`: Float target score.
*   `data/processed_test_lipids.pkl`: Same format as above, for the test set.
*   `data/lipid_stats.pkl`: Python dictionary with `{'mean': ..., 'std': ...}` calculated from the `transfection_score` values in the *training* set.
*   `data/processed_unlabeled_lipids.pkl`: Python list of dictionaries for the unlabeled dataset (from SDF). Format is the same as above but **without** the `'transfection_score'` key.

## Execution Workflow

Follow these steps sequentially. 

**Step 1: Preprocess Labeled Data (CSV -> PKL)**

*   **Purpose**: Generates 3D structures from SMILES, extracts features/scores, calculates statistics.
*   **Script**: `preprocess_lipids.py`
*   **Command**:
    ```bash
    python preprocess_lipids.py
    ```
*   **Output**: Creates `data/processed_train_lipids.pkl`, `data/processed_test_lipids.pkl`, `data/lipid_stats.pkl`.

**Step 2: Preprocess Unlabeled Data (SDF -> PKL)**

*   **Purpose**: Processes the large unlabeled SDF file into the required format for adaptation.
*   **Script**: `preprocess_unlabeled_lipids.py`
*   **Command**:
    ```bash
    python preprocess_unlabeled_lipids.py
    ```
*   **Output**: Creates `data/processed_unlabeled_lipids.pkl`.
    *Note: Both preprocessing scripts incorporate fallbacks for conformer generation (`useRandomCoords=True`) which may be needed for complex lipids.* 

**Step 3: Stage 1 - Adapt Model on Unlabeled Data**

*   **Purpose**: Fine-tune the original GEOM-Drugs model on general lipid structures without conditioning.
*   **Script**: `GeoLDM/stage1_adapt_lipids.py`
*   **Inputs**: 
    *   `data/processed_unlabeled_lipids.pkl`
    *   Pre-trained GEOM-Drugs model (assumed path: `GeoLDM/drugs_latent2/`)
*   **Command** (adjust paths, epochs, batch size, LR as needed):
    ```bash
    python -m GeoLDM.stage1_adapt_lipids \
        --unlabeled_data_path "data/processed_unlabeled_lipids.pkl" \
        --pretrained_path "GeoLDM/drugs_latent2/" \
        --model_name "generative_model_ema.npy" \
        --exp_name "lipid_adapt_stage1_run1" \
        --output_dir "outputs/stage1_adapt" \
        --n_epochs 50 \
        --batch_size 4 \
        --no-condition_time_cmd  \
        --lr 5e-9 \
        --no-trainable_ae_cmd \
        --val_split_ratio 0.01 &> outputs/lipid_adapt_stage1_run1/experiment_full.log
        
    ```
*   **Output**: Saves adapted model checkpoints (e.g., `stage1_adapted_ema_best.npy`) into `outputs/stage1_adapt/lipid_adapt_stage1_run1/checkpoints/`.

**Step 4: Stage 2 - Conditional Fine-tuning on Labeled Data**

*   **Purpose**: Fine-tune the *adapted* model from Stage 1 using labeled data and conditioning on `transfection_score`.
*   **Script**: `GeoLDM/finetune_lipids.py`
*   **Inputs**:
    *   `data/processed_train_lipids.pkl` (for training)
    *   `data/processed_test_lipids.pkl` (used automatically for validation)
    *   `data/lipid_stats.pkl`
    *   Adapted model checkpoint from Stage 1.
*   **Command** (adjust paths, checkpoint names, epochs, LR etc. as needed):
    ```bash
    python -m GeoLDM.finetune_lipids \
        --lipid_data_path "data/processed_train_lipids.pkl" \
        --lipid_stats_path "data/lipid_stats.pkl" \
        --pretrained_path "outputs/stage1_adapt/lipid_adapt_stage1_run1/checkpoints/" \
        --model_name "stage1_adapted_ema_best.npy" \
        --conditioning transfection_score \
        --exp_name "lipid_finetune_stage2_run1" \
        --output_dir "outputs/stage2_finetune" \
        --n_epochs 75 \
        --batch_size 8 \
        --lr 5e-8  &> outputs/lipid_stage2_finetuning/experiment_full.log
    ```
*   **Output**: Saves the final fine-tuned model checkpoints (e.g., `generative_model_ema_best.npy`) into `outputs/stage2_finetune/lipid_finetune_stage2_run1/checkpoints/`. This is the model to use for conditional generation.

**Step 5: Generate Molecules Conditioned on High Score**

*   **Purpose**: Use the final fine-tuned model (from Stage 2) to generate new lipid molecules, aiming for a high `transfection_score` using Classifier-Free Guidance (CFG).
*   **Script**: `GeoLDM/generate_lipids.py`
*   **Inputs**:
    *   Fine-tuned model checkpoint directory from Stage 2.
    *   `data/lipid_stats.pkl` (for conditioning).
*   **Command** (adjust paths, checkpoint name, number of samples, target score standard deviation, and guidance scale `w` as needed):
    ```bash
    python GeoLDM/generate_lipids.py \
        --model_path "outputs/stage2_finetune/lipid_finetune_stage2_run1/checkpoints/" \
        --model_name "generative_model_ema_best.npy" \
        --stats_path "data/lipid_stats.pkl" \
        --output_path "generated_lipids/lipids_cfg_w5_std2.sdf" \
        --n_samples 1000 \
        --target_score_std 2.0 \
        --guidance_scale 5.0 \
        --batch_size 50
    ```
*   **Output**: Creates an SDF file (e.g., `generated_lipids/lipids_cfg_w5_std2.sdf`) containing the generated 3D structures.

**Step 6: Evaluate Generated Molecules**

*   **Purpose**: Filter the generated molecules for validity and structural features (e.g., tertiary amine), predict their transfection scores using the external TransLNP model, and rank them.
*   **Script**: `evaluate_generated.py`
*   **Inputs**:
    *   SDF file containing generated molecules (from Step 5).
    *   TransLNP model weights and dictionary (paths specified as arguments).
*   **Command** (adjust input/output paths, model/dict paths, and filtering/ranking parameters as needed):
    ```bash
    python evaluate_generated.py \
        --input_sdf "generated_lipids/lipids_cfg_w5_std2.sdf" \
        --output_file "generated_lipids/evaluated_lipids_cfg_w5_std2.sdf" \
        --translnp_model "TransLNP/weights/mol_pre_all_h_220816.pt" \
        --translnp_dict "TransLNP/weights/mol.dict.txt" \
        --filter_smarts "[NX3;H0;!$(*=[!#6]);!$(*[!#6]=[!#6])]" \
        --top_n 20
    ```
*   **Output**: 
    *   Prints the top N molecules (SMILES and predicted scores) to the console.
    *   Saves an SDF file (e.g., `generated_lipids/evaluated_lipids_cfg_w5_std2.sdf`) containing the filtered molecules with their predicted scores added as properties.

## Key Scripts

*   **`preprocess_lipids.py`**: Processes labeled CSV data (`train.csv`, `test.csv`) into `.pkl` format and calculates statistics.
*   **`preprocess_unlabeled_lipids.py`**: Processes unlabeled SDF data (`structures.sdf`) into `.pkl` format.
*   **`GeoLDM/lipid_dataset.py`**: Defines PyTorch Dataset and DataLoader logic for loading `.pkl` files, handling padding and batching.
*   **`GeoLDM/stage1_adapt_lipids.py`**: Training script for Stage 1 (unconditional adaptation on unlabeled data).
*   **`GeoLDM/finetune_lipids.py`**: Training script for Stage 2 (conditional fine-tuning on labeled data).
*   **`GeoLDM/core/`**: Directory containing core model implementations (EGNN, Diffusion), losses, utilities, etc. (Renamed from `qm9`).
*   **`GeoLDM/configs/`**: Contains dataset configurations (`datasets_config.py`).
*   **`GeoLDM/eval_sample.py`, `GeoLDM/eval_analyze.py`**: Original evaluation scripts, potentially useful for sampling from the final model and analyzing results (may require adaptation).

## Original GeoLDM Pre-training

The scripts `GeoLDM/main_geom_drugs.py` and `GeoLDM/build_geom_dataset.py` have been retained to allow for potential re-running of the original GEOM-Drugs pre-training if needed. 